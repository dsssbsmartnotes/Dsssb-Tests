<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>DSSSB CBT Professional Portal (Pro + Rank)</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
window.MathJax = {
  tex: { inlineMath: [['$', '$'], ['\\(', '\\)']], displayMath: [['$$', '$$']] },
  svg: { fontCache: 'global' },
  startup: { typeset: false }
};
</script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>

<style>
/* =========================
   CORE THEME & VIBRANT VARIABLES
   ========================= */
:root {
  --primary-hue: 250; 
  --primary: hsl(var(--primary-hue), 80%, 60%);
  --primary-dark: hsl(var(--primary-hue), 80%, 45%);
  --primary-light: hsl(var(--primary-hue), 90%, 95%);
  --gradient-main: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
  --gradient-header: linear-gradient(90deg, #4f46e5, #9333ea);
  
  --success: #10b981;
  --success-bg: #d1fae5;
  --danger: #ef4444;
  --danger-bg: #fee2e2;
  --warning: #f59e0b;
  --warning-bg: #fef3c7;
  
  --bg-body: #f3f4f6;
  --bg-body-gradient: linear-gradient(135deg, #eff6ff 0%, #f5f3ff 100%);
  --bg-card: rgba(255, 255, 255, 0.95);
  --glass-border: rgba(255, 255, 255, 0.6);
  
  --text-main: #1e293b;
  --text-muted: #64748b;
  --border-color: #e2e8f0;
  
  --shadow-sm: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
  --shadow-lg: 0 10px 25px -5px rgba(99, 102, 241, 0.15);
  
  --header-height: 64px;
  --footer-height: 64px;
  --radius-lg: 16px;
}

body.dark-mode {
  --primary: #818cf8;
  --primary-dark: #6366f1;
  --primary-light: rgba(99, 102, 241, 0.1);
  --gradient-main: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
  --gradient-header: linear-gradient(90deg, #312e81, #581c87);
  
  --bg-body: #0f172a;
  --bg-body-gradient: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%);
  --bg-card: #1e293b;
  --glass-border: #334155;
  
  --text-main: #f8fafc;
  --text-muted: #94a3b8;
  --border-color: #334155;
  --shadow-lg: 0 10px 30px rgba(0,0,0,0.5);
}

* { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
html, body { width: 100%; height: 100%; margin: 0; padding: 0; font-family: 'Poppins', 'Segoe UI', system-ui, sans-serif; background: var(--bg-body-gradient); color: var(--text-main); overflow: hidden; user-select: none; transition: background 0.3s ease; }
body { display: grid; grid-template-rows: var(--header-height) auto 1fr var(--footer-height); }

/* --- POPUPS & TOAST --- */
#tgPopup {
  position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%);
  background: var(--bg-card); padding: 30px; width: 85%; max-width: 340px;
  border-radius: 20px; box-shadow: 0 25px 50px rgba(0,0,0,0.25);
  z-index: 9999; text-align: center; display: none; color: var(--text-main);
  border: 1px solid var(--border-color); backdrop-filter: blur(10px);
}
#tgPopup a { display: block; background: #0088cc; color: #fff; padding: 14px; border-radius: 12px; text-decoration: none; margin-top: 20px; font-weight: bold; box-shadow: 0 4px 10px rgba(0,136,204,0.3); transition: transform 0.2s; }
#tgPopup a:active { transform: scale(0.98); }
.tg-btn-continue { background: transparent; color: var(--text-muted); border: 2px solid var(--border-color); padding: 10px 20px; border-radius: 12px; margin-top: 15px; cursor: pointer; font-weight: 600; width: 100%; transition: 0.2s; }
.tg-btn-continue:hover { border-color: var(--primary); color: var(--primary); }

#toast-container { position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%); z-index: 10000; display: flex; flex-direction: column; gap: 10px; align-items: center; pointer-events: none; width: 90%; max-width: 400px; }
.toast { background: rgba(15, 23, 42, 0.9); color: #fff; padding: 12px 24px; border-radius: 50px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); display: flex; align-items: center; gap: 12px; font-size: 14px; animation: slideUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); pointer-events: auto; backdrop-filter: blur(8px); border: 1px solid rgba(255,255,255,0.1); }
.toast.success { border-left: 5px solid var(--success); } .toast.error { border-left: 5px solid var(--danger); }
@keyframes slideUp { from { opacity: 0; transform: translateY(30px) scale(0.9); } to { opacity: 1; transform: translateY(0) scale(1); } }

/* --- LOGIN --- */
.full-overlay { position: fixed; inset: 0; background: var(--bg-body-gradient); z-index: 2000; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; overflow-y: auto; }
.login-card { background: var(--bg-card); padding: 40px 30px; border-radius: 24px; box-shadow: var(--shadow-lg); width: 100%; max-width: 420px; text-align: center; border: 1px solid var(--glass-border); backdrop-filter: blur(10px); }
.login-input { width: 100%; padding: 14px; margin: 10px 0; border: 2px solid var(--border-color); border-radius: 12px; background: rgba(255,255,255,0.05); color: var(--text-main); font-size: 16px; transition: 0.3s; }
.login-input:focus { border-color: var(--primary); box-shadow: 0 0 0 4px var(--primary-light); }
.btn-primary { background: var(--gradient-main); color: #fff; border: none; padding: 14px; width: 100%; border-radius: 12px; font-weight: bold; font-size: 16px; cursor: pointer; margin-top: 20px; transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4); }
.btn-primary:active { transform: scale(0.98); }

/* --- HEADER --- */
header { background: var(--gradient-header); box-shadow: 0 4px 20px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; z-index: 50; height: var(--header-height); color: white; }
.brand { font-weight: 900; font-size: 20px; color: #fff; display: flex; align-items: center; gap: 8px; letter-spacing: 0.5px; text-shadow: 0 2px 4px rgba(0,0,0,0.1); }
.header-tools { display: flex; gap: 10px; align-items: center; }
.timer-badge { background: rgba(255,255,255,0.2); color: #fff; padding: 6px 12px; border-radius: 8px; font-weight: 700; font-family: 'Courier New', monospace; font-size: 16px; border: 1px solid rgba(255,255,255,0.3); backdrop-filter: blur(4px); }
.timer-badge.low { background: rgba(239, 68, 68, 0.9); animation: pulse 1s infinite; }
.nav-btn { padding: 8px 12px; border-radius: 8px; font-weight: 600; cursor: pointer; border: none; background: rgba(255,255,255,0.15); color: #fff; font-size: 14px; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
.nav-btn:hover { background: rgba(255,255,255,0.3); }
@keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

/* --- SECTION BAR --- */
#sectionBar { background: var(--bg-card); border-bottom: 1px solid var(--border-color); display: flex; overflow-x: auto; scrollbar-width: none; white-space: nowrap; height: 55px; align-items: center; padding: 0 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); }
.sec-tab { padding: 0 18px; height: 36px; border-radius: 18px; margin: 0 4px; font-size: 13px; font-weight: 600; color: var(--text-muted); display: flex; align-items: center; gap: 6px; transition: 0.3s; border: 1px solid transparent; }
.sec-tab.active { background: var(--gradient-main); color: #fff; box-shadow: 0 2px 8px rgba(99, 102, 241, 0.4); }
.sec-tab.done { color: var(--success); background: var(--success-bg); border-color: var(--success); }

/* --- MAIN LAYOUT --- */
#mainArea { padding: 20px; overflow-y: auto; display: none; position: relative; }
.q-card { background: var(--bg-card); border-radius: var(--radius-lg); border: 1px solid var(--border-color); padding: 25px; box-shadow: var(--shadow-sm); margin-bottom: 25px; transition: transform 0.2s; }
.q-header { display: flex; justify-content: space-between; margin-bottom: 15px; border-bottom: 1px dashed var(--border-color); padding-bottom: 12px; font-size: 14px; color: var(--text-muted); font-weight: 600; }
.q-text { font-size: 17px; line-height: 1.6; margin-bottom: 20px; font-weight: 500; color: var(--text-main); }
.q-text img, .opt img { max-width: 100%; height: auto; border-radius: 8px; cursor: zoom-in; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-top: 8px; }

.opt { display: flex; align-items: center; padding: 14px; border: 2px solid var(--border-color); border-radius: 12px; margin-bottom: 12px; cursor: pointer; transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94); background: var(--bg-card); font-size: 15px; position: relative; overflow: hidden; }
.opt:hover { border-color: var(--primary); background: var(--primary-light); transform: translateY(-2px); }
.opt.sel { background: var(--primary-light); border-color: var(--primary); font-weight: 600; box-shadow: 0 4px 10px rgba(99, 102, 241, 0.2); }
.opt-badge { width: 30px; height: 30px; border-radius: 50%; background: var(--bg-body); border: 2px solid var(--border-color); display: flex; align-items: center; justify-content: center; margin-right: 15px; font-size: 12px; font-weight: 800; flex-shrink: 0; color: var(--text-muted); transition: 0.2s; }
.opt.sel .opt-badge { background: var(--primary); border-color: var(--primary); color: #fff; }

.opt.correct-ans { border-color: var(--success); background: var(--success-bg); }
.opt.correct-ans .opt-badge { background: var(--success); border-color: var(--success); color: #fff; }
.opt.wrong-ans { border-color: var(--danger); background: var(--danger-bg); }
.opt.wrong-ans .opt-badge { background: var(--danger); border-color: var(--danger); color: #fff; }

/* --- FOOTER --- */
footer { background: var(--bg-card); padding: 0 15px; border-top: 1px solid var(--border-color); display: flex; justify-content: space-between; gap: 12px; display: none; z-index: 40; align-items: center; height: var(--footer-height); box-shadow: 0 -4px 20px rgba(0,0,0,0.05); }
footer .nav-btn { height: 44px; flex: 1; max-width: 140px; background: transparent; border: 2px solid var(--border-color); color: var(--text-main); }
footer .btn-grid { max-width: 60px; font-size: 20px; border-color: transparent; }
footer .nav-btn.primary { background: var(--gradient-main); color: #fff; border: none; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3); }

/* --- PALETTE PANEL --- */
#palettePanel { 
    position: fixed; top: 0; right: 0; bottom: 0;
    width: 300px; background: var(--bg-card); z-index: 2000; 
    display: flex; flex-direction: column; 
    box-shadow: -5px 0 30px rgba(0,0,0,0.2); 
    transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
#palettePanel.show { transform: translateX(0); }
.modal-header { padding: 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; font-weight: 800; font-size: 18px; color: var(--primary); background: var(--primary-light); }
.p-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; padding: 20px; overflow-y: auto; flex: 1; align-content: start; }
.qbtn { aspect-ratio: 1; border-radius: 10px; border: 1px solid var(--border-color); background: var(--bg-body); font-weight: 700; font-size: 13px; cursor: pointer; color: var(--text-main); transition: 0.2s; }

.qbtn.current { border: 2px solid var(--primary); background: #fff; color: var(--primary); transform: scale(1.1); }
.qbtn.answered { background: var(--success); color: #fff; border: none; }
.qbtn.review { background: var(--warning); color: #fff; border: none; }
.qbtn.p-correct { background: var(--success); color: #fff; border-color: var(--success); }
.qbtn.p-wrong { background: var(--danger); color: #fff; border-color: var(--danger); }
.qbtn.p-skip { background: var(--text-muted); color: #fff; border-color: var(--text-muted); opacity: 0.5; }

/* --- RESULT MODALS & DASHBOARD --- */
.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 1500; display: none; backdrop-filter: blur(5px); justify-content: center; align-items: center; padding: 15px; }
.modal-card { background: var(--bg-card); width: 100%; max-width: 800px; max-height: 90vh; border-radius: 24px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.4); border: 1px solid var(--glass-border); }
.modal-body { padding: 25px; overflow-y: auto; }

/* Testbook Style Analysis Container */
.analysis-container { max-width: 900px; margin: auto; display: flex; flex-direction: column; gap: 14px; padding: 10px 0; font-family: 'Poppins', sans-serif; }
.card-dashboard { background: var(--bg-card); border-radius: 12px; padding: 16px; box-shadow: var(--shadow-sm); border: 1px solid var(--border-color); }
.info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; font-size: 14px; color: var(--text-muted); }
.info-grid div b { color: var(--text-main); }
.score-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; text-align: center; }
.score-item { background: var(--primary-light); border-radius: 10px; padding: 14px; border: 1px solid rgba(99, 102, 241, 0.2); }
.score-item h4 { margin: 0; font-size: 13px; color: var(--primary-dark); text-transform: uppercase; letter-spacing: 0.5px; }
.score-item p { margin: 6px 0 0; font-size: 20px; font-weight: 800; color: var(--text-main); }
.attempt-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; text-align: center; }
.attempt-box { padding: 12px; border-radius: 10px; font-weight: 700; font-size: 13px; border: 1px solid transparent; }
.attempt-box span { display: block; font-size: 20px; margin-top: 4px; font-weight: 800; }

.at-correct { background: var(--success-bg); color: var(--success); border-color: rgba(16, 185, 129, 0.3); }
.at-wrong { background: var(--danger-bg); color: var(--danger); border-color: rgba(239, 68, 68, 0.3); }
.at-unattempted { background: var(--warning-bg); color: #b77c00; border-color: rgba(245, 158, 11, 0.3); }
.at-total { background: var(--primary-light); color: var(--primary-dark); border-color: rgba(99, 102, 241, 0.3); }

/* Comparison Bars */
.bar-section { margin-top: 10px; }
.bar-label { display: flex; justify-content: space-between; font-size: 13px; font-weight: 700; margin-bottom: 6px; color: var(--text-muted); }
.bar-track { height: 10px; background: var(--border-color); border-radius: 99px; overflow: hidden; position: relative; }
.bar-fill { height: 100%; border-radius: 99px; transition: width 1s ease-out; }
.fill-you { background: var(--primary); }
.fill-topper { background: var(--success); }

/* Leaderboard */
.topper-table { width: 100%; border-collapse: collapse; font-size: 14px; margin-top: 10px; }
.topper-table th { background: var(--bg-body); color: var(--text-muted); font-weight: 700; padding: 10px; text-align: left; border-bottom: 2px solid var(--border-color); }
.topper-table td { padding: 10px; border-bottom: 1px solid var(--border-color); color: var(--text-main); }
.section-title { font-size: 16px; font-weight: 700; margin: 0 0 14px; color: var(--text-main); padding-bottom: 8px; border-bottom: 1px solid var(--border-color); }

@media(max-width: 480px) {
    #palettePanel { width: 85%; } 
    .brand span { font-size: 24px; } .brand { font-size: 18px; }
    .timer-badge { font-size: 14px; padding: 4px 10px; }
    .nav-btn { padding: 6px 10px; font-size: 12px; }
    .sec-tab { padding: 0 12px; font-size: 12px; height: 32px; }
    .dashboard-grid { grid-template-columns: 1fr; }
}
</style>
</head>
<body onload="initApp()">

<script>
  document.addEventListener("DOMContentLoaded", function() {
    if (window.Telegram && window.Telegram.WebApp) {
        const tg = window.Telegram.WebApp;
        tg.expand(); // Full screen inside Telegram
        
        // SECURITY CHECK: Agar link kisi ne Chrome/Safari mein copy paste kiya toh Access Denied
        if (!tg.initData) {
            document.body.innerHTML = `
                <div style="display:flex; height:100vh; width:100vw; background:var(--bg-body-gradient); color:var(--text-main); justify-content:center; align-items:center; flex-direction:column; text-align:center; padding:20px; font-family: 'Poppins', sans-serif;">
                    <h1 style="color:var(--danger); font-size:60px; margin:0;">üö´</h1>
                    <h2 style="margin:10px 0;">Access Denied!</h2>
                    <p style="color:var(--text-muted); font-weight:500;">This premium test can only be accessed via the official Telegram App.<br>Please open it directly from our private channel.</p>
                </div>
            `;
            return;
        } else {
            // Agar genuine user hai, toh uska naam Telegram se nikal kar form me pre-fill kar do
            const user = tg.initDataUnsafe.user;
            if(user && user.first_name) {
                setTimeout(() => {
                    const nameInput = document.getElementById('startNameInput');
                    if(nameInput) {
                        nameInput.value = user.first_name + (user.last_name ? " " + user.last_name : "");
                        // Aap chahein toh user ko name change karne se rok sakte hain:
                        // nameInput.readOnly = true;
                    }
                }, 500);
            }
        }
    }
  });
</script>
<div id="tgPopup">
  <div style="font-size:40px; margin-bottom:10px;">üì¢</div>
  <h3 style="margin:0; color:var(--primary);">Join DSSSB Rank</h3>
  <p style="font-size:13px; color:var(--text-muted); margin:10px 0 20px;">Get Daily Mock Tests, PDFs & Live Leaderboards</p>
  <a href="https://t.me/DSSSBRank" target="_blank">üöÄ Join Telegram Channel</a>
  <button class="tg-btn-continue" onclick="closeTg()">Continue Test</button>
</div>

<div id="zoomModal" onclick="closeZoom()" style="position:fixed; inset:0; background:rgba(0,0,0,0.95); z-index:5000; display:none; justify-content:center; align-items:center; flex-direction:column;">
    <span style="position:absolute; top:20px; right:20px; font-size:40px; color:#fff; cursor:pointer;">&times;</span>
    <img id="zoomImg" src="" style="max-width:95%; max-height:80vh; border-radius:12px; box-shadow:0 0 50px rgba(255,255,255,0.1);">
    <div style="color:#fff; margin-top:15px; font-size:14px; opacity:0.7;">Click anywhere to close</div>
</div>

<div id="paletteOverlay" onclick="togglePalette()" style="position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:1900; display:none; backdrop-filter:blur(2px);"></div>
<div id="toast-container"></div>

<div id="startScreen" class="full-overlay">
    <div class="login-card">
        <div style="font-size:50px; margin-bottom:15px;">üõ°Ô∏è</div>
        <h2 style="margin:0 0 5px 0; color:var(--text-main); font-weight:800;">DSSSB Pro Portal</h2>
        <p style="color:var(--text-muted); font-size:14px; margin-bottom:30px;">Secure Computer Based Test System</p>
        
        <div style="text-align:left; margin-bottom:5px; font-size:13px; font-weight:600; margin-left:5px;">Full Name</div>
        <input type="text" id="startNameInput" class="login-input" placeholder="e.g. Rahul Sharma">
        
        <div id="resumeBox" style="display:none; margin-top:20px; background:rgba(245, 158, 11, 0.1); padding:15px; border-radius:12px; border:1px solid var(--warning); color:var(--warning); font-size:13px; text-align:left;">
            <b>‚ö†Ô∏è Session Recovered</b><br>
            We found an incomplete test saved on this device.
            <div style="margin-top:12px; display:flex; gap:10px;">
                <button onclick="loadState()" style="padding:8px 15px; background:var(--warning); color:white; border:none; border-radius:8px; cursor:pointer; font-weight:bold;">Resume Test</button>
                <button onclick="clearState()" style="padding:8px 15px; background:none; border:1px solid var(--warning); color:var(--warning); border-radius:8px; cursor:pointer; font-weight:bold;">Start New</button>
            </div>
        </div>
        
        <button class="btn-primary" onclick="validateLogin()">START EXAM ‚ûî</button>
    </div>
</div>

<header>
    <div class="brand"><span>üõ°Ô∏è</span> DSSSB <span style="opacity:0.8; font-weight:400; font-size:16px;">CBT</span></div>
    <div class="header-tools">
        <div id="timer" class="timer-badge">120:00</div>
        <button class="nav-btn" onclick="toggleTheme()" title="Dark Mode">üåô</button>
        <button class="nav-btn" onclick="toggleLang()" id="langBtn" style="width:40px;">HI</button>
        <button class="nav-btn" onclick="toggleFS()" title="Fullscreen">‚õ∂</button>
    </div>
</header>

<div id="sectionBar"></div>

<div id="mainArea">
    <div class="q-card">
        <div class="q-header">
            <span style="display:flex; align-items:center; gap:8px;"><span style="background:var(--primary); color:#fff; padding:2px 8px; border-radius:6px; font-size:12px;">Q.<span id="qNumDisp">1</span></span></span>
            <span style="font-family:monospace; font-size:14px;"><span style="color:var(--success)">+1.0</span> &nbsp;|&nbsp; <span style="color:var(--danger)">-0.25</span></span>
        </div>
        <div id="qContent" class="q-text"></div>
        <div id="opts"></div>
        <div id="solutionDisplay" class="sol-box" style="display:none; margin-top:20px;"></div>
        
        <div style="margin-top:25px; display:flex; gap:15px;">
            <button class="nav-btn" style="border:1px solid var(--warning); color:var(--warning); flex:1; background:transparent;" onclick="markReview()">‚≠ê Mark for Review</button>
            <button class="nav-btn" style="border:1px solid var(--text-muted); color:var(--text-muted); flex:1; background:transparent;" onclick="clearResponse()">‚Ü∫ Clear Response</button>
        </div>
    </div>
    <div style="height:40px;"></div>
</div>

<div id="palettePanel">
    <div class="modal-header">
        <span>Question Palette</span>
        <button onclick="togglePalette()" style="border:none; background:none; font-size:24px; color:var(--primary); cursor:pointer;">&times;</button>
    </div>
    <div class="p-grid" id="paletteGrid"></div>
    <div style="padding:20px; border-top:1px solid var(--border-color); background:var(--bg-body);">
        <button id="mainSubmitBtn" onclick="submitTest()" class="btn-primary" style="background:var(--danger); box-shadow:0 4px 15px rgba(239, 68, 68, 0.4);">SUBMIT EXAM</button>
    </div>
</div>

<div id="resultModal" class="modal-overlay">
    <div class="modal-card">
        <div class="modal-header">
            <span>üèÜ Analysis & Leaderboard</span>
            <button onclick="closeResult()" style="border:none; background:none; font-size:24px; color:var(--primary); cursor:pointer;">&times;</button>
        </div>
        <div class="modal-body" id="resultContent"></div>
    </div>
</div>

<footer>
    <button class="nav-btn btn-grid" onclick="togglePalette()">‚ñ¶ Grid</button>
    <button class="nav-btn" onclick="prev()">Before</button>
    <button class="nav-btn primary" id="nextBtn" onclick="next()">Save & Next</button>
</footer>
<script>
/* =========================
   FIREBASE CONFIG & INIT
   ========================= */
const firebaseConfig = {
  apiKey: "AIzaSyDGolcXv0efZxRdOvBthfeT72mkNLLbAwI",
  authDomain: "dsssbexamportal.firebaseapp.com",
  databaseURL: "https://dsssbexamportal-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "dsssbexamportal",
  storageBucket: "dsssbexamportal.firebasestorage.app",
  messagingSenderId: "853373171134",
  appId: "1:853373171134:web:77b967374e6f34311af5ef"
};

// Initialize Firebase
if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
}
const db = firebase.database();

/* =========================
   DATA & CONFIG (UPDATED)
   ========================= */
const TEST_ID = "TEST_002"; // <--- CHANGE THIS FOR EVERY NEW TEST
const DB_REF_NAME = "dsssb_results_live";

const TOTAL_TIME_MINS = 120;
const STORAGE_KEY = "dsssb_cbt_rank_v2";
const NEGATIVE_MARK = 0.25;
const TELEGRAM_BOT_TOKEN="8486464606:AAFT_Bd0P2HYqKNPjCm3s7TGgfM4HWmOYvs";
const TELEGRAM_CHAT_ID="@dsssbcbtresult";
const PASSING_MARKS = 3; 

const QUESTIONS = [
  {
    section: "General Computer Knowledge",
    q_en: "Comments can be accessed from which tab of MS PowerPoint?",
    q_hi: "MS PowerPoint ‡§ï‡•á ‡§ï‡§ø‡§∏ ‡§ü‡•à‡§¨ ‡§∏‡•á ‡§ï‡§Æ‡•á‡§Ç‡§ü‡•ç‡§∏ (Comments) ‡§ï‡•ã ‡§è‡§ï‡•ç‡§∏‡•á‡§∏ ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à?",
    ans: "2",
    op_en: ["Insert", "Review", "Design", "Home"],
    op_hi: ["‡§á‡§Ç‡§∏‡§∞‡•ç‡§ü (Insert)", "‡§∞‡§ø‡§µ‡•ç‡§Ø‡•Ç (Review)", "‡§°‡§ø‡§ú‡§º‡§æ‡§á‡§® (Design)", "‡§π‡•ã‡§Æ (Home)"],
    solution: "<b>Buy PRO</b> for detailed explanation and solution."
  },
  {
    section: "General Computer Knowledge",
    q_en: "How many NAND gates are used to make a AND gate?",
    q_hi: "‡§è‡§ï AND ‡§ó‡•á‡§ü ‡§¨‡§®‡§æ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡§ø‡§§‡§®‡•á NAND ‡§ó‡•á‡§ü‡•ç‡§∏ ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ‡§§‡§æ ‡§π‡•à?",
    ans: "2",
    op_en: ["0", "2", "3", "1"],
    op_hi: ["0", "2", "3", "1"],
    solution: "<b>Buy PRO</b> for detailed explanation and solution."
  },
  {
    section: "General Computer Knowledge",
    q_en: "______ shortcut key is used to open a new blank document in MS word.",
    q_hi: "MS Word ‡§Æ‡•á‡§Ç ‡§è‡§ï ‡§®‡§Ø‡§æ ‡§∞‡§ø‡§ï‡•ç‡§§ ‡§¶‡§∏‡•ç‡§§‡§æ‡§µ‡•á‡§ú‡§º ‡§ñ‡•ã‡§≤‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ______ ‡§∂‡•â‡§∞‡•ç‡§ü‡§ï‡§ü ‡§ï‡•Å‡§Ç‡§ú‡•Ä ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ‡§§‡§æ ‡§π‡•à‡•§",
    ans: "3",
    op_en: ["Ctrl + P", "Ctrl + O", "Ctrl + N", "Ctrl + S"],
    op_hi: ["Ctrl + P", "Ctrl + O", "Ctrl + N", "Ctrl + S"],
    solution: "<b>Buy PRO</b> for detailed explanation and solution."
  },
  {
    section: "General Computer Knowledge",
    q_en: "In ______, IBM introduced the personal computer for home and office use.",
    q_hi: "______ ‡§Æ‡•á‡§Ç, IBM ‡§®‡•á ‡§ò‡§∞ ‡§î‡§∞ ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§æ‡§≤‡§Ø ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡•á ‡§≤‡§ø‡§è ‡§™‡§∞‡•ç‡§∏‡§®‡§≤ ‡§ï‡§Ç‡§™‡•ç‡§Ø‡•Ç‡§ü‡§∞ ‡§™‡•á‡§∂ ‡§ï‡§ø‡§Ø‡§æ‡•§",
    ans: "3",
    op_en: ["1986", "1985", "1981", "1975"],
    op_hi: ["1986", "1985", "1981", "1975"],
    solution: "<b>Buy PRO</b> for detailed explanation and solution."
  },
  {
    section: "General Computer Knowledge",
    q_en: "The first page or main page of a website is called ______.",
    q_hi: "‡§ï‡§ø‡§∏‡•Ä ‡§µ‡•á‡§¨‡§∏‡§æ‡§á‡§ü ‡§ï‡•á ‡§™‡§π‡§≤‡•á ‡§™‡•É‡§∑‡•ç‡§† ‡§Ø‡§æ ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§™‡•É‡§∑‡•ç‡§† ‡§ï‡•ã ______ ‡§ï‡§π‡§æ ‡§ú‡§æ‡§§‡§æ ‡§π‡•à‡•§",
    ans: "1",
    op_en: ["Home Page", "Cane Page", "Upload Page", "Break Page"],
    op_hi: ["‡§π‡•ã‡§Æ ‡§™‡•á‡§ú (Home Page)", "‡§ï‡•á‡§® ‡§™‡•á‡§ú (Cane Page)", "‡§Ö‡§™‡§≤‡•ã‡§° ‡§™‡•á‡§ú (Upload Page)", "‡§¨‡•ç‡§∞‡•á‡§ï ‡§™‡•á‡§ú (Break Page)"],
    solution: "<b>Buy PRO</b> for detailed explanation and solution."
  },
  {
    section: "General Computer Knowledge",
    q_en: "What is the full form of CISC?",
    q_hi: "CISC ‡§ï‡§æ ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§∞‡•Ç‡§™ ‡§ï‡•ç‡§Ø‡§æ ‡§π‡•à?",
    ans: "1",
    op_en: ["Complex Instruction Set Computer", "Complex Instruction Set Complex", "Computer Instruction Set Complex", "Computer Instruction Set Computer"],
    op_hi: ["Complex Instruction Set Computer", "Complex Instruction Set Complex", "Computer Instruction Set Complex", "Computer Instruction Set Computer"],
    solution: "<b>Buy PRO</b> for detailed explanation and solution."
  },
  {
    section: "General Computer Knowledge",
    q_en: "Which among the following is the keyboard shortcut to switch between open programs?",
    q_hi: "‡§ñ‡•Å‡§≤‡•á ‡§π‡•Å‡§è ‡§™‡•ç‡§∞‡•ã‡§ó‡•ç‡§∞‡§æ‡§Æ‡•ç‡§∏ ‡§ï‡•á ‡§¨‡•Ä‡§ö ‡§∏‡•ç‡§µ‡§ø‡§ö ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§®‡§ø‡§Æ‡•ç‡§®‡§≤‡§ø‡§ñ‡§ø‡§§ ‡§Æ‡•á‡§Ç ‡§∏‡•á ‡§ï‡•å‡§® ‡§∏‡§æ ‡§ï‡•Ä‡§¨‡•ã‡§∞‡•ç‡§° ‡§∂‡•â‡§∞‡•ç‡§ü‡§ï‡§ü ‡§π‡•à?",
    ans: "4",
    op_en: ["Alt + V", "Alt + T", "Alt + Ctrl", "Alt + Tab"],
    op_hi: ["Alt + V", "Alt + T", "Alt + Ctrl", "Alt + Tab"],
    solution: "<b>Buy PRO</b> for detailed explanation and solution."
  },
  {
    section: "General Computer Knowledge",
    q_en: "Which shortcut key is used to open replace dialog box in MS PowerPoint?",
    q_hi: "MS PowerPoint ‡§Æ‡•á‡§Ç ‡§∞‡§ø‡§™‡•ç‡§≤‡•á‡§∏ (Replace) ‡§°‡§æ‡§Ø‡§≤‡•â‡§ó ‡§¨‡•â‡§ï‡•ç‡§∏ ‡§ñ‡•ã‡§≤‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡§ø‡§∏ ‡§∂‡•â‡§∞‡•ç‡§ü‡§ï‡§ü ‡§ï‡•Å‡§Ç‡§ú‡•Ä ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ‡§§‡§æ ‡§π‡•à?",
    ans: "2",
    op_en: ["Alt + H", "Ctrl + H", "Ctrl + F", "Alt + F"],
    op_hi: ["Alt + H", "Ctrl + H", "Ctrl + F", "Alt + F"],
    solution: "<b>Buy PRO</b> for detailed explanation and solution."
  },
  {
    section: "General Computer Knowledge",
    q_en: "Both the inputs of NAND gate are connected to A. What is the output?",
    q_hi: "NAND ‡§ó‡•á‡§ü ‡§ï‡•á ‡§¶‡•ã‡§®‡•ã‡§Ç ‡§á‡§®‡§™‡•Å‡§ü A ‡§∏‡•á ‡§ú‡•Å‡§°‡§º‡•á ‡§π‡•à‡§Ç‡•§ ‡§Ü‡§â‡§ü‡§™‡•Å‡§ü ‡§ï‡•ç‡§Ø‡§æ ‡§π‡•ã‡§ó‡§æ?",
    ans: "4",
    op_en: ["1", "A", "0", "A-bar (Not A)"],
    op_hi: ["1", "A", "0", "A-bar (Not A)"],
    solution: "<b>Buy PRO</b> for detailed explanation and solution."
  },
  {
    section: "General Computer Knowledge",
    q_en: "If the two inputs of NOR gate are 0 and 1, then what is the output?",
    q_hi: "‡§Ø‡§¶‡§ø NOR ‡§ó‡•á‡§ü ‡§ï‡•á ‡§¶‡•ã ‡§á‡§®‡§™‡•Å‡§ü 0 ‡§î‡§∞ 1 ‡§π‡•à‡§Ç, ‡§§‡•ã ‡§Ü‡§â‡§ü‡§™‡•Å‡§ü ‡§ï‡•ç‡§Ø‡§æ ‡§π‡•ã‡§ó‡§æ?",
    ans: "3",
    op_en: ["Logical Error", "Either 0 or 1", "0", "1"],
    op_hi: ["‡§≤‡•â‡§ú‡§ø‡§ï‡§≤ ‡§è‡§∞‡§∞ (Logical Error)", "‡§Ø‡§æ ‡§§‡•ã 0 ‡§Ø‡§æ 1", "0", "1"],
    solution: "<b>Buy PRO</b> for detailed explanation and solution."
  },
  {
    section: "General Computer Knowledge",
    q_en: "Which generation of computers used artificial intelligence?",
    q_hi: "‡§ï‡§Ç‡§™‡•ç‡§Ø‡•Ç‡§ü‡§∞ ‡§ï‡•Ä ‡§ï‡§ø‡§∏ ‡§™‡•Ä‡§¢‡§º‡•Ä ‡§®‡•á ‡§Ü‡§∞‡•ç‡§ü‡§ø‡§´‡§ø‡§∂‡§ø‡§Ø‡§≤ ‡§á‡§Ç‡§ü‡•á‡§≤‡§ø‡§ú‡•á‡§Ç‡§∏ (Artificial Intelligence) ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§ø‡§Ø‡§æ?",
    ans: "1",
    op_en: ["5", "2", "3", "4"],
    op_hi: ["5‡§µ‡•Ä‡§Ç", "‡§¶‡•Ç‡§∏‡§∞‡•Ä", "‡§§‡•Ä‡§∏‡§∞‡•Ä", "‡§ö‡•å‡§•‡•Ä"],
    solution: "<b>Buy PRO</b> for detailed explanation and solution."
  },
  {
    section: "General Computer Knowledge",
    q_en: "I. RAM - Volatile<br>II. ROM - Non Volatile",
    q_hi: "I. RAM - ‡§µ‡•ã‡§≤‡•á‡§ü‡§æ‡§á‡§≤ (‡§Ö‡§∏‡•ç‡§•‡§æ‡§Ø‡•Ä)<br>II. ROM - ‡§®‡•â‡§®-‡§µ‡•ã‡§≤‡•á‡§ü‡§æ‡§á‡§≤ (‡§∏‡•ç‡§•‡§æ‡§Ø‡•Ä)",
    ans: "3",
    op_en: ["Only I", "Neither I nor II", "Both I and II", "Only II"],
    op_hi: ["‡§ï‡•á‡§µ‡§≤ I", "‡§® ‡§§‡•ã I ‡§® ‡§π‡•Ä II", "I ‡§î‡§∞ II ‡§¶‡•ã‡§®‡•ã‡§Ç", "‡§ï‡•á‡§µ‡§≤ II"],
    solution: "<b>Buy PRO</b> for detailed explanation and solution."
  },
  {
    section: "General Computer Knowledge",
    q_en: "What is the full form of ISDN?",
    q_hi: "ISDN ‡§ï‡§æ ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§∞‡•Ç‡§™ ‡§ï‡•ç‡§Ø‡§æ ‡§π‡•à?",
    ans: "4",
    op_en: ["International Services Dark Network", "Integrated Services Dark Network", "International Services Digital Network", "Integrated Services Digital Network"],
    op_hi: ["International Services Dark Network", "Integrated Services Dark Network", "International Services Digital Network", "Integrated Services Digital Network"],
    solution: "<b>Buy PRO</b> for detailed explanation and solution."
  },
  {
    section: "General Computer Knowledge",
    q_en: "Which of the following pair is correct?<br>I. Mouse - Input<br>II. Scanner - Output<br>III. Joystick - Input",
    q_hi: "‡§®‡§ø‡§Æ‡•ç‡§®‡§≤‡§ø‡§ñ‡§ø‡§§ ‡§Æ‡•á‡§Ç ‡§∏‡•á ‡§ï‡•å‡§® ‡§∏‡§æ ‡§Ø‡•Å‡§ó‡•ç‡§Æ ‡§∏‡§π‡•Ä ‡§π‡•à?<br>I. ‡§Æ‡§æ‡§â‡§∏ - ‡§á‡§®‡§™‡•Å‡§ü<br>II. ‡§∏‡•ç‡§ï‡•à‡§®‡§∞ - ‡§Ü‡§â‡§ü‡§™‡•Å‡§ü<br>III. ‡§ú‡•â‡§Ø‡§∏‡•ç‡§ü‡§ø‡§ï - ‡§á‡§®‡§™‡•Å‡§ü",
    ans: "3",
    op_en: ["I, II and III", "II and III", "I and III", "I and II"],
    op_hi: ["I, II ‡§î‡§∞ III", "II ‡§î‡§∞ III", "I ‡§î‡§∞ III", "I ‡§î‡§∞ II"],
    solution: "<b>Buy PRO</b> for detailed explanation and solution."
  },
  {
    section: "General Computer Knowledge",
    q_en: "A ______ key is a key on a computer's keyboard that is only used in conjunction with another key.",
    q_hi: "‡§ï‡§Ç‡§™‡•ç‡§Ø‡•Ç‡§ü‡§∞ ‡§ï‡•á ‡§ï‡•Ä‡§¨‡•ã‡§∞‡•ç‡§° ‡§™‡§∞ ‡§è‡§ï ______ ‡§ï‡•Å‡§Ç‡§ú‡•Ä ‡§µ‡§π ‡§ï‡•Å‡§Ç‡§ú‡•Ä ‡§π‡•ã‡§§‡•Ä ‡§π‡•à ‡§ú‡§ø‡§∏‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡•á‡§µ‡§≤ ‡§ï‡§ø‡§∏‡•Ä ‡§Ö‡§®‡•ç‡§Ø ‡§ï‡•Å‡§Ç‡§ú‡•Ä ‡§ï‡•á ‡§∏‡§æ‡§• ‡§∏‡§Ç‡§Ø‡•ã‡§ú‡§® ‡§Æ‡•á‡§Ç ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ‡§§‡§æ ‡§π‡•à‡•§",
    ans: "2",
    op_en: ["Punctuation", "Modifier", "Symbol", "Function"],
    op_hi: ["‡§µ‡§ø‡§∞‡§æ‡§Æ ‡§ö‡§ø‡§π‡•ç‡§® (Punctuation)", "‡§∏‡§Ç‡§∂‡•ã‡§ß‡§ï (Modifier)", "‡§™‡•ç‡§∞‡§§‡•Ä‡§ï (Symbol)", "‡§´‡§Ç‡§ï‡•ç‡§∂‡§® (Function)"],
    solution: "<b>Buy PRO</b> for detailed explanation and solution."
  },
  {
    section: "General Computer Knowledge",
    q_en: "What is the full form of TCP?",
    q_hi: "TCP ‡§ï‡§æ ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§∞‡•Ç‡§™ ‡§ï‡•ç‡§Ø‡§æ ‡§π‡•à?",
    ans: "4",
    op_en: ["Transfer Control Policy", "Transmission Control Policy", "Transfer Control Protocol", "Transmission Control Protocol"],
    op_hi: ["Transfer Control Policy", "Transmission Control Policy", "Transfer Control Protocol", "Transmission Control Protocol"],
    solution: "<b>Buy PRO</b> for detailed explanation and solution."
  },
  {
    section: "General Computer Knowledge",
    q_en: "Which of the following is a primary memory?<br>I. RAM<br>II. ROM",
    q_hi: "‡§®‡§ø‡§Æ‡•ç‡§®‡§≤‡§ø‡§ñ‡§ø‡§§ ‡§Æ‡•á‡§Ç ‡§∏‡•á ‡§ï‡•å‡§® ‡§∏‡•Ä ‡§è‡§ï ‡§™‡•ç‡§∞‡§æ‡§•‡§Æ‡§ø‡§ï ‡§Æ‡•á‡§Æ‡•ã‡§∞‡•Ä ‡§π‡•à?<br>I. RAM<br>II. ROM",
    ans: "3",
    op_en: ["Only I", "Neither I nor II", "Both I and II", "Only II"],
    op_hi: ["‡§ï‡•á‡§µ‡§≤ I", "‡§® ‡§§‡•ã I ‡§® ‡§π‡•Ä II", "I ‡§î‡§∞ II ‡§¶‡•ã‡§®‡•ã‡§Ç", "‡§ï‡•á‡§µ‡§≤ II"],
    solution: "<b>Buy PRO</b> for detailed explanation and solution."
  },
  {
    section: "General Computer Knowledge",
    q_en: "Which of the following is not a web browser?",
    q_hi: "‡§®‡§ø‡§Æ‡•ç‡§®‡§≤‡§ø‡§ñ‡§ø‡§§ ‡§Æ‡•á‡§Ç ‡§∏‡•á ‡§ï‡•å‡§® ‡§∏‡§æ ‡§µ‡•á‡§¨ ‡§¨‡•ç‡§∞‡§æ‡§â‡§ú‡§º‡§∞ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à?",
    ans: "1",
    op_en: ["All are web browsers", "Opera", "Chrome", "Mosaic"],
    op_hi: ["‡§∏‡§≠‡•Ä ‡§µ‡•á‡§¨ ‡§¨‡•ç‡§∞‡§æ‡§â‡§ú‡§º‡§∞ ‡§π‡•à‡§Ç", "Opera", "Chrome", "Mosaic"],
    solution: "<b>Buy PRO</b> for detailed explanation and solution."
  },
  {
    section: "General Computer Knowledge",
    q_en: "Which shortcut key is used to underline the content of a cell in MS Excel?",
    q_hi: "MS Excel ‡§Æ‡•á‡§Ç ‡§ï‡§ø‡§∏‡•Ä ‡§∏‡•á‡§≤ ‡§ï‡•Ä ‡§∏‡§æ‡§Æ‡§ó‡•ç‡§∞‡•Ä ‡§ï‡•ã ‡§∞‡•á‡§ñ‡§æ‡§Ç‡§ï‡§ø‡§§ (underline) ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡§ø‡§∏ ‡§∂‡•â‡§∞‡•ç‡§ü‡§ï‡§ü ‡§ï‡•Å‡§Ç‡§ú‡•Ä ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ‡§§‡§æ ‡§π‡•à?",
    ans: "2",
    op_en: ["Ctrl + 2", "Ctrl + 4", "Ctrl + 1", "Ctrl + 3"],
    op_hi: ["Ctrl + 2", "Ctrl + 4", "Ctrl + 1", "Ctrl + 3"],
    solution: "<b>Buy PRO</b> for detailed explanation and solution."
  },
  {
    section: "General Computer Knowledge",
    q_en: "Which of the following numbers is understood by computers?",
    q_hi: "‡§®‡§ø‡§Æ‡•ç‡§®‡§≤‡§ø‡§ñ‡§ø‡§§ ‡§Æ‡•á‡§Ç ‡§∏‡•á ‡§ï‡•å‡§® ‡§∏‡•Ä ‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ ‡§ï‡§Ç‡§™‡•ç‡§Ø‡•Ç‡§ü‡§∞ ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§∏‡§Æ‡§ù‡•Ä ‡§ú‡§æ‡§§‡•Ä ‡§π‡•à?",
    ans: "1",
    op_en: ["Binary Numbers", "Fractions", "Whole Numbers", "Integers"],
    op_hi: ["‡§¨‡§æ‡§á‡§®‡§∞‡•Ä ‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ‡§è‡§Å (Binary Numbers)", "‡§≠‡§ø‡§®‡•ç‡§® (Fractions)", "‡§™‡•Ç‡§∞‡•ç‡§£ ‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ‡§è‡§Å (Whole Numbers)", "‡§™‡•Ç‡§∞‡•ç‡§£‡§æ‡§Ç‡§ï (Integers)"],
    solution: "<b>Buy PRO</b> for detailed explanation and solution."
  },
  {
    section: "General Computer Knowledge",
    q_en: "Which of the following is a correct email address?",
    q_hi: "‡§®‡§ø‡§Æ‡•ç‡§®‡§≤‡§ø‡§ñ‡§ø‡§§ ‡§Æ‡•á‡§Ç ‡§∏‡•á ‡§ï‡•å‡§® ‡§∏‡§æ ‡§è‡§ï ‡§∏‡§π‡•Ä ‡§à‡§Æ‡•á‡§≤ ‡§è‡§°‡•ç‡§∞‡•á‡§∏ ‡§π‡•à?",
    ans: "3",
    op_en: ["jonsnow.pmail.com", "jonsnow.pmail@com", "jonsnow@pmail.com", "jonsnow@pmail@com"],
    op_hi: ["jonsnow.pmail.com", "jonsnow.pmail@com", "jonsnow@pmail.com", "jonsnow@pmail@com"],
    solution: "<b>Buy PRO</b> for detailed explanation and solution."
  },
  {
    section: "General Computer Knowledge",
    q_en: "Which shortcut key is used to insert hyperlink in MS Excel?",
    q_hi: "MS Excel ‡§Æ‡•á‡§Ç ‡§π‡§æ‡§á‡§™‡§∞‡§≤‡§ø‡§Ç‡§ï (hyperlink) ‡§°‡§æ‡§≤‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡§ø‡§∏ ‡§∂‡•â‡§∞‡•ç‡§ü‡§ï‡§ü ‡§ï‡•Å‡§Ç‡§ú‡•Ä ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ‡§§‡§æ ‡§π‡•à?",
    ans: "2",
    op_en: ["Alt + K", "Ctrl + K", "Ctrl + 1", "Alt + 1"],
    op_hi: ["Alt + K", "Ctrl + K", "Ctrl + 1", "Alt + 1"],
    solution: "<b>Buy PRO</b> for detailed explanation and solution."
  },
  {
    section: "General Computer Knowledge",
    q_en: "Which of the following is correct?<br>I. Secondary memory has low storage capacity than the primary memory.<br>II. Secondary memory is costlier than primary memory.",
    q_hi: "‡§®‡§ø‡§Æ‡•ç‡§®‡§≤‡§ø‡§ñ‡§ø‡§§ ‡§Æ‡•á‡§Ç ‡§∏‡•á ‡§ï‡•å‡§® ‡§∏‡§æ ‡§ï‡§•‡§® ‡§∏‡§π‡•Ä ‡§π‡•à?<br>I. ‡§∏‡•á‡§ï‡•á‡§Ç‡§°‡§∞‡•Ä ‡§Æ‡•á‡§Æ‡•ã‡§∞‡•Ä ‡§ï‡•Ä ‡§∏‡•ç‡§ü‡•ã‡§∞‡•á‡§ú ‡§ï‡•ç‡§∑‡§Æ‡§§‡§æ ‡§™‡•ç‡§∞‡§æ‡§á‡§Æ‡§∞‡•Ä ‡§Æ‡•á‡§Æ‡•ã‡§∞‡•Ä ‡§∏‡•á ‡§ï‡§Æ ‡§π‡•ã‡§§‡•Ä ‡§π‡•à‡•§<br>II. ‡§∏‡•á‡§ï‡•á‡§Ç‡§°‡§∞‡•Ä ‡§Æ‡•á‡§Æ‡•ã‡§∞‡•Ä ‡§™‡•ç‡§∞‡§æ‡§á‡§Æ‡§∞‡•Ä ‡§Æ‡•á‡§Æ‡•ã‡§∞‡•Ä ‡§∏‡•á ‡§Ö‡§ß‡§ø‡§ï ‡§Æ‡§π‡§Ç‡§ó‡•Ä ‡§π‡•ã‡§§‡•Ä ‡§π‡•à‡•§",
    ans: "2",
    op_en: ["Only I", "Neither I nor II", "Both I and II", "Only II"],
    op_hi: ["‡§ï‡•á‡§µ‡§≤ I", "‡§® ‡§§‡•ã I ‡§® ‡§π‡•Ä II", "I ‡§î‡§∞ II ‡§¶‡•ã‡§®‡•ã‡§Ç", "‡§ï‡•á‡§µ‡§≤ II"],
    solution: "<b>Buy PRO</b> for detailed explanation and solution."
  },
  {
    section: "General Computer Knowledge",
    q_en: "Insert citation can be accessed from which tab of MS Word?",
    q_hi: "MS Word ‡§ï‡•á ‡§ï‡§ø‡§∏ ‡§ü‡•à‡§¨ ‡§∏‡•á '‡§á‡§Ç‡§∏‡§∞‡•ç‡§ü ‡§∏‡§æ‡§á‡§ü‡•á‡§∂‡§®' (Insert Citation) ‡§ï‡•ã ‡§è‡§ï‡•ç‡§∏‡•á‡§∏ ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à?",
    ans: "3",
    op_en: ["Insert", "Review", "References", "Home"],
    op_hi: ["‡§á‡§Ç‡§∏‡§∞‡•ç‡§ü (Insert)", "‡§∞‡§ø‡§µ‡•ç‡§Ø‡•Ç (Review)", "‡§∞‡•á‡§´‡§∞‡•á‡§Ç‡§∏‡•á‡§∏ (References)", "‡§π‡•ã‡§Æ (Home)"],
    solution: "<b>Buy PRO</b> for detailed explanation and solution."
  },
  {
    section: "General Computer Knowledge",
    q_en: "What is the full form of CPU?",
    q_hi: "CPU ‡§ï‡§æ ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§∞‡•Ç‡§™ ‡§ï‡•ç‡§Ø‡§æ ‡§π‡•à?",
    ans: "1",
    op_en: ["Central Processing Unit", "Central Processor Utility", "Central Processor Unit", "Central Processing Utility"],
    op_hi: ["Central Processing Unit", "Central Processor Utility", "Central Processor Unit", "Central Processing Utility"],
    solution: "<b>Buy PRO</b> for detailed explanation and solution."
  }
];

// --- DYNAMIC SECTION MAP (QUESTIONS Array se automatically subjects uthayega) ---
const SECTION_MAP = [...new Set(QUESTIONS.map(q => q.section))];

let currentState = { idx: 0, answers: new Array(QUESTIONS.length).fill(null), review: new Array(QUESTIONS.length).fill(false), time: TOTAL_TIME_MINS * 60, secIdx: 0, submitted: false, name: "" };
let timerInt;
let secIndices = [];

/* =========================
   CORE FUNCTIONS
   ========================= */
function initApp() {
    calcSectionIndices();
    const saved = localStorage.getItem(STORAGE_KEY);
    if(saved) document.getElementById('resumeBox').style.display = 'block';
}

function calcSectionIndices() { 
    SECTION_MAP.forEach(sec => { 
        const start = QUESTIONS.findIndex(q => q.section === sec); 
        secIndices.push(start !== -1 ? start : 0); 
    }); 
}

function validateLogin() {
    const name = document.getElementById('startNameInput').value.trim();
    if(!name) return showToast("Please Enter Your Name", "error");
    currentState.name = name;
    startGame(false);
}

function startGame(isResuming) {
    document.getElementById('startScreen').style.display = 'none';
    document.querySelector('header').style.display = 'flex';
    document.getElementById('mainArea').style.display = 'block';
    document.querySelector('footer').style.display = 'flex';
    renderSectionTabs();
    if(!isResuming) currentState.idx = secIndices[0];
    loadQuestion(currentState.idx);
    startTimer();
    setInterval(saveState, 5000); 
    showToast(`Welcome, ${currentState.name} üöÄ`, "success");
    toggleFS(); 
    if(!isResuming) document.getElementById('tgPopup').style.display = "block"; 
}

function saveState() {
    if(currentState.submitted) { localStorage.removeItem(STORAGE_KEY); return; }
    localStorage.setItem(STORAGE_KEY, JSON.stringify(currentState));
}

function loadState() { 
    const saved = localStorage.getItem(STORAGE_KEY); 
    if(saved) { currentState = JSON.parse(saved); startGame(true); } 
}

function clearState() { 
    localStorage.removeItem(STORAGE_KEY); 
    document.getElementById('resumeBox').style.display = 'none'; 
    showToast("Session Cleared", "info"); 
}

function renderSectionTabs() {
    const bar = document.getElementById('sectionBar'); let html = "";
    SECTION_MAP.forEach((sec, i) => {
        let cls = "sec-tab"; let icon = "üîí";
        if (currentState.submitted) {
            cls += " done"; icon = "üîì";
            if (i === currentState.secIdx) { cls += " active"; icon = "üëÅÔ∏è"; }
        } else {
            if(i === currentState.secIdx) { cls += " active"; icon = "üü¢"; }
            else if(i < currentState.secIdx) { cls += " done"; icon = "‚úÖ"; }
        }
        html += `<div class="${cls}" onclick="jumpSection(${i})">${icon} ${sec}</div>`;
    });
    bar.innerHTML = html;
}

function jumpSection(secIndex) {
    if(currentState.submitted) {
        currentState.secIdx = secIndex;
        loadQuestion(secIndices[secIndex]);
        renderSectionTabs();
    }
}

function loadQuestion(idx) {
    currentState.idx = idx; 
    const q = QUESTIONS[idx]; 
    const isHindi = document.getElementById('langBtn').innerText === "HI";
    
    const qSecIdx = SECTION_MAP.indexOf(q.section);
    if(qSecIdx !== -1 && qSecIdx !== currentState.secIdx) {
        currentState.secIdx = qSecIdx;
        renderSectionTabs();
    }

    document.getElementById('qNumDisp').innerText = idx + 1;
    
    const contentDiv = document.getElementById('qContent');
    contentDiv.innerHTML = isHindi ? (q.q_hi || q.q_en) : (q.q_en || q.q_hi);
    contentDiv.querySelectorAll('img').forEach(img => { img.onclick = () => openZoom(img.src); });

    let optsHtml = ""; 
    const correctIdx = parseInt(q.ans) - 1;
    const optsArr = isHindi ? (q.op_hi || q.op_en) : (q.op_en || q.op_hi);
    
    optsArr.forEach((opt, i) => {
        let cls = "opt"; 
        const myAns = currentState.answers[idx];
        
        if (currentState.submitted) {
            if (i === correctIdx) cls += " correct-ans";
            else if (i === myAns && i !== correctIdx) cls += " wrong-ans";
        } else {
            if(myAns === i) cls += " sel";
        }

        optsHtml += `<div class="${cls}" onclick="selectAns(${i})"><div class="opt-badge">${String.fromCharCode(65+i)}</div><div style="width:100%">${opt}</div></div>`;
    });
    
    const optsContainer = document.getElementById('opts');
    optsContainer.innerHTML = optsHtml;
    optsContainer.querySelectorAll('img').forEach(img => { img.onclick = (e) => { e.stopPropagation(); openZoom(img.src); }; });

    const solBox = document.getElementById('solutionDisplay');
    if(currentState.submitted) {
        solBox.innerHTML = `<b>üí° Solution:</b><br>${q.solution}`;
        solBox.style.display = 'block';
    } else {
        solBox.style.display = 'none';
    }

    updateNavButtons(); 
    renderPalette(); 
    if(window.MathJax) MathJax.typesetPromise();
}

function selectAns(i) { 
    if(currentState.submitted) return; 
    currentState.answers[currentState.idx] = i; 
    loadQuestion(currentState.idx); 
    saveState(); 
}

function next() {
    if(currentState.idx < QUESTIONS.length - 1) {
        if (currentState.submitted) {
            loadQuestion(currentState.idx + 1);
            return;
        }

        const nextQ = QUESTIONS[currentState.idx + 1]; 
        const currQ = QUESTIONS[currentState.idx];
        if(nextQ.section !== currQ.section) {
            if(confirm(`Finish ${currQ.section} section?`)) { 
                currentState.secIdx++; 
                renderSectionTabs(); 
                loadQuestion(currentState.idx + 1); 
            }
        } else { 
            loadQuestion(
                currentState.idx + 1); 
        }
    } else {
        if (!currentState.submitted) {
            submitTest();
        }
    }
}

function prev() { 
    if(currentState.idx > 0) { 
        loadQuestion(currentState.idx - 1); 
        if (!currentState.submitted) {
            const prevQ = QUESTIONS[currentState.idx - 1];
            const currQ = QUESTIONS[currentState.idx];
            if (prevQ.section !== currQ.section) {
                 currentState.secIdx--;
                 renderSectionTabs();
            }
        }
    } 
}

function markReview() {
    if(currentState.submitted) return;
    currentState.review[currentState.idx] = !currentState.review[currentState.idx];
    loadQuestion(currentState.idx);
    saveState();
    showToast(currentState.review[currentState.idx] ? "Marked for Review" : "Review Removed", "info");
}

function clearResponse() {
    if(currentState.submitted) return;
    currentState.answers[currentState.idx] = null;
    loadQuestion(currentState.idx);
    saveState();
    showToast("Response Cleared", "info");
}

function updateNavButtons() {
    const nextBtn = document.getElementById('nextBtn');
    if (currentState.submitted) {
        nextBtn.innerText = currentState.idx === QUESTIONS.length - 1 ? "Finish Analysis" : "Next Solution";
        if (currentState.idx === QUESTIONS.length - 1) {
            nextBtn.onclick = closeResult; // Just closes the app or goes to a final screen
        } else {
            nextBtn.onclick = next;
        }
    } else {
        nextBtn.innerText = currentState.idx === QUESTIONS.length - 1 ? "Submit Exam" : "Save & Next";
        if (currentState.idx === QUESTIONS.length - 1) {
            nextBtn.onclick = submitTest;
        } else {
            nextBtn.onclick = next;
        }
    }
}

/* =========================
   TIMER & UTILS
   ========================= */
function startTimer() {
    const tBadge = document.getElementById('timer');
    timerInt = setInterval(() => {
        if(currentState.time <= 0 || currentState.submitted) {
            clearInterval(timerInt);
            if (!currentState.submitted) submitTest();
            return;
        }
        currentState.time--;
        const m = Math.floor(currentState.time / 60).toString().padStart(2, '0');
        const s = (currentState.time % 60).toString().padStart(2, '0');
        tBadge.innerText = `${m}:${s}`;
        
        if (currentState.time < 300) { // Last 5 minutes
            tBadge.classList.add('low');
        } else {
            tBadge.classList.remove('low');
        }
        saveState();
    }, 1000);
}

function toggleTheme() { 
    document.body.classList.toggle('dark-mode'); 
    showToast("Theme Changed", "success"); 
}

function toggleLang() { 
    const b = document.getElementById('langBtn'); 
    b.innerText = b.innerText === "HI" ? "EN" : "HI"; 
    loadQuestion(currentState.idx); 
    showToast("Language Switched", "success"); 
}

function toggleFS() {
    if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().catch(err => {
            console.log(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`);
        });
    } else {
        if (document.exitFullscreen) {
            document.exitFullscreen();
        }
    }
}

function showToast(msg, type="info") {
    const t = document.createElement('div');
    t.className = `toast ${type}`;
    t.innerHTML = `${type==='success'?'‚úÖ':type==='error'?'‚ùå':'‚ÑπÔ∏è'} <span>${msg}</span>`;
    document.getElementById('toast-container').appendChild(t);
    setTimeout(() => { t.style.opacity = '0'; setTimeout(() => t.remove(), 400); }, 3000);
}

function openZoom(src) {
    document.getElementById('zoomImg').src = src;
    document.getElementById('zoomModal').style.display = "flex";
}

function closeZoom() {
    document.getElementById('zoomModal').style.display = "none";
}

function closeTg() {
    document.getElementById('tgPopup').style.display = "none";
}

/* =========================
   PALETTE PANEL
   ========================= */
function togglePalette() {
    const p = document.getElementById('palettePanel');
    const o = document.getElementById('paletteOverlay');
    if (p.classList.contains('show')) {
        p.classList.remove('show');
        o.style.display = 'none';
    } else {
        p.classList.add('show');
        o.style.display = 'block';
        renderPalette();
    }
}

function renderPalette() {
    const grid = document.getElementById('paletteGrid');
    let html = "";
    
    QUESTIONS.forEach((q, i) => {
        let cls = "qbtn";
        
        if (currentState.submitted) {
            const correctIdx = parseInt(q.ans) - 1;
            const userAns = currentState.answers[i];
            if (userAns === correctIdx) cls += " p-correct";
            else if (userAns !== null) cls += " p-wrong";
            else cls += " p-skip";
        } else {
             if (i === currentState.idx) cls += " current";
             if (currentState.review[i]) cls += " review";
             else if (currentState.answers[i] !== null) cls += " answered";
        }
        
        html += `<button class="${cls}" onclick="jumpToQ(${i})">${i + 1}</button>`;
    });
    grid.innerHTML = html;
}

function jumpToQ(idx) {
    togglePalette(); // Close palette
    loadQuestion(idx);
}

/* =========================
   SUBMIT & ANALYSIS
   ========================= */
function submitTest() {
    if(!currentState.submitted) {
        if(!confirm("Are you sure you want to submit the exam?")) return;
    }
    
    clearInterval(timerInt);
    currentState.submitted = true;
    localStorage.removeItem(STORAGE_KEY);
    
    document.getElementById('mainSubmitBtn').style.display = 'none'; // Hide submit button in palette
    
    calculateResults();
}

function calculateResults() {
    let score = 0, correct = 0, wrong = 0, unattempted = 0;
    
    // Calculate total score and section-wise
    const sectionStats = {};
    SECTION_MAP.forEach(sec => {
        sectionStats[sec] = { correct: 0, wrong: 0, unattempted: 0, score: 0, total: 0 };
    });

    QUESTIONS.forEach((q, i) => {
        const sec = q.section;
        sectionStats[sec].total++;
        const userAns = currentState.answers[i];
        const correctIdx = parseInt(q.ans) - 1;

        if (userAns === null) {
            unattempted++;
            sectionStats[sec].unattempted++;
        } else if (userAns === correctIdx) {
            correct++;
            score += 1;
            sectionStats[sec].correct++;
            sectionStats[sec].score += 1;
        } else {
            wrong++;
            score -= NEGATIVE_MARK;
            sectionStats[sec].wrong++;
            sectionStats[sec].score -= NEGATIVE_MARK;
        }
    });

    const totalQuestions = QUESTIONS.length;
    const maxMarks = totalQuestions * 1; // Assuming 1 mark per question
    const percentage = ((score / maxMarks) * 100).toFixed(2);
    const resultStatus = score >= PASSING_MARKS ? "PASSED üéâ" : "FAILED üíî";
    const statusColor = score >= PASSING_MARKS ? "var(--success)" : "var(--danger)";

    // Prepare Result Data for Firebase
    const resultData = {
        name: currentState.name,
        score: parseFloat(score.toFixed(2)),
        correct: correct,
        wrong: wrong,
        unattempted: unattempted,
        percentage: parseFloat(percentage),
        timestamp: firebase.database.ServerValue.TIMESTAMP
    };

    // Save to Firebase
    db.ref(`${DB_REF_NAME}/${TEST_ID}`).push(resultData)
      .then(() => {
          console.log("Result saved to Firebase successfully.");
          fetchLeaderboard(resultData, sectionStats, resultStatus, statusColor, maxMarks);
      })
      .catch((error) => {
          console.error("Error saving result: ", error);
          showToast("Error saving result to server. Showing local analysis.", "error");
          // Still show analysis even if Firebase fails
          showAnalysisModal(resultData, sectionStats, resultStatus, statusColor, maxMarks, []);
      });
}

function fetchLeaderboard(currentResult, sectionStats, resultStatus, statusColor, maxMarks) {
    db.ref(`${DB_REF_NAME}/${TEST_ID}`).orderByChild('score').limitToLast(10).once('value', (snapshot) => {
        const leaderboardData = [];
        snapshot.forEach((childSnapshot) => {
            leaderboardData.push({
                id: childSnapshot.key,
                ...childSnapshot.val()
            });
        });
        
        // Sort descending
        leaderboardData.sort((a, b) => b.score - a.score);
        
        // Check if current user is in top, if not, we still just show top 10
        showAnalysisModal(currentResult, sectionStats, resultStatus, statusColor, maxMarks, leaderboardData);
        
        // Send to Telegram
        sendResultToTelegram(currentResult, leaderboardData);
    });
}

function showAnalysisModal(resultData, sectionStats, resultStatus, statusColor, maxMarks, leaderboard) {
    const modal = document.getElementById('resultModal');
    const content = document.getElementById('resultContent');
    
    let topperScore = leaderboard.length > 0 ? leaderboard[0].score : resultData.score;
    let rank = "-";
    // Basic rank calculation if possible based on fetched data. 
    // For precise rank among ALL users, a different query is needed.
    // For now, if they are in the top 10 fetched, show that rank.
    const userRankIndex = leaderboard.findIndex(u => u.name === resultData.name && u.score === resultData.score);
    if(userRankIndex !== -1) {
        rank = userRankIndex + 1;
    }

    let sectionHtml = "";
    SECTION_MAP.forEach(sec => {
        const stat = sectionStats[sec];
        sectionHtml += `
            <div style="margin-top:15px; padding:10px; border:1px solid var(--border-color); border-radius:8px; background:var(--primary-light);">
                <div style="font-weight:700; color:var(--primary-dark); margin-bottom:5px;">${sec}</div>
                <div style="display:flex; justify-content:space-between; font-size:13px; color:var(--text-main);">
                    <span>Score: <b>${stat.score.toFixed(2)}</b>/${stat.total}</span>
                    <span style="color:var(--success)">Right: ${stat.correct}</span>
                    <span style="color:var(--danger)">Wrong: ${stat.wrong}</span>
                </div>
            </div>
        `;
    });

    let leaderboardHtml = "";
    if (leaderboard.length > 0) {
        leaderboardHtml = `<table class="topper-table">
            <thead><tr><th>Rank</th><th>Name</th><th>Score</th></tr></thead>
            <tbody>`;
        leaderboard.forEach((entry, idx) => {
            let rowStyle = entry.name === resultData.name ? "background: var(--primary-light); font-weight: bold;" : "";
            let rankIcon = idx === 0 ? "ü•á" : idx === 1 ? "ü•à" : idx === 2 ? "ü•â" : `${idx + 1}`;
            leaderboardHtml += `<tr style="${rowStyle}"><td>${rankIcon}</td><td>${entry.name}</td><td>${entry.score.toFixed(2)}</td></tr>`;
        });
        leaderboardHtml += `</tbody></table>`;
    } else {
         leaderboardHtml = `<div style="text-align:center; padding:20px; color:var(--text-muted);">No records yet.</div>`;
    }

    content.innerHTML = `
        <div class="analysis-container" id="pdfContent">
            
            <div style="text-align:center; margin-bottom:20px;">
                <h2 style="margin:0; color:var(--primary); font-size:24px;">Performance Analysis</h2>
                <div style="font-size:18px; font-weight:800; color:${statusColor}; margin-top:5px;">${resultStatus}</div>
            </div>

            <div class="card-dashboard">
                <div class="score-summary">
                    <div class="score-item">
                        <h4>Your Score</h4>
                        <p>${resultData.score.toFixed(2)} <span style="font-size:14px; font-weight:normal; color:var(--text-muted)">/ ${maxMarks}</span></p>
                    </div>
                    <div class="score-item">
                        <h4>Rank (Top 10)</h4>
                        <p>${rank}</p>
                    </div>
                    <div class="score-item">
                        <h4>Accuracy</h4>
                        <p>${(resultData.correct / (resultData.correct + resultData.wrong) * 100 || 0).toFixed(0)}%</p>
                    </div>
                </div>
            </div>

            <div class="card-dashboard">
                <h3 class="section-title">Attempt Summary</h3>
                <div class="attempt-summary">
                    <div class="attempt-box at-correct">Correct <span>${resultData.correct}</span></div>
                    <div class="attempt-box at-wrong">Wrong <span>${resultData.wrong}</span></div>
                    <div class="attempt-box at-unattempted">Skipped <span>${resultData.unattempted}</span></div>
                    <div class="attempt-box at-total">Total <span>${QUESTIONS.length}</span></div>
                </div>
            </div>

            <div class="card-dashboard">
                <h3 class="section-title">Score Comparison</h3>
                <div class="bar-section">
                    <div class="bar-label"><span>You (${resultData.score.toFixed(2)})</span></div>
                    <div class="bar-track">
                        <div class="bar-fill fill-you" style="width: ${(Math.max(0, resultData.score) / maxMarks) * 100}%"></div>
                    </div>
                </div>
                <div class="bar-section">
                    <div class="bar-label"><span>Topper (${topperScore.toFixed(2)})</span></div>
                    <div class="bar-track">
                        <div class="bar-fill fill-topper" style="width: ${(Math.max(0, topperScore) / maxMarks) * 100}%"></div>
                    </div>
                </div>
            </div>
            
            <div class="card-dashboard">
                <h3 class="section-title">Sectional Performance</h3>
                ${sectionHtml}
            </div>

            <div class="card-dashboard">
                <h3 class="section-title">Top 10 Leaderboard</h3>
                ${leaderboardHtml}
            </div>
            
        </div>
        
        <div style="display:flex; gap:15px; margin-top:20px;">
            <button class="btn-primary" style="flex:1;" onclick="closeResultAndReview()">Review Solutions</button>
            <button class="btn-primary" style="flex:1; background:var(--success); box-shadow:0 4px 15px rgba(16, 185, 129, 0.4);" onclick="downloadPDF()">Download PDF</button>
        </div>
    `;
    
    modal.style.display = "flex";
}

function closeResultAndReview() {
    document.getElementById('resultModal').style.display = "none";
    loadQuestion(0); // Start review from first question
    renderSectionTabs();
    updateNavButtons();
}

function closeResult() {
    document.getElementById('resultModal').style.display = "none";
}

function sendResultToTelegram(resultData, leaderboard) {
    const text = `
üèÜ *New Test Submission* (${TEST_ID})
üë§ Name: *${resultData.name}*
üéØ Score: *${resultData.score}* / ${QUESTIONS.length}
‚úÖ Correct: ${resultData.correct} | ‚ùå Wrong: ${resultData.wrong} | ‚è≥ Skipped: ${resultData.unattempted}
üìà Accuracy: ${(resultData.correct / (resultData.correct + resultData.wrong) * 100 || 0).toFixed(0)}%

*Current Top 3:*
1Ô∏è‚É£ ${leaderboard[0] ? leaderboard[0].name + " - " + leaderboard[0].score : "-"}
2Ô∏è‚É£ ${leaderboard[1] ? leaderboard[1].name + " - " + leaderboard[1].score : "-"}
3Ô∏è‚É£ ${leaderboard[2] ? leaderboard[2].name + " - " + leaderboard[2].score : "-"}
    `;

    const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;
    fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            chat_id: TELEGRAM_CHAT_ID,
            text: text,
            parse_mode: 'Markdown'
        })
    }).catch(e => console.error("Telegram Send Error:", e));
}

function downloadPDF() {
    const element = document.getElementById('pdfContent');
    const opt = {
        margin:       10,
        filename:     `Result_${TEST_ID}_${currentState.name.replace(/\s+/g, '_')}.pdf`,
        image:        { type: 'jpeg', quality: 0.98 },
        html2canvas:  { scale: 2 },
        jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };
    html2pdf().set(opt).from(element).save();
}

</script>

</body>
</html>
